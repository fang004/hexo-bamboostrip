/**
 * Copyright 2006-2015 GrapeCity inc
 * Author: isaac.fang@grapecity.com
 */

var Stream = require('stream'),
    path = require('path'),
    Q = require('q'),
    gulp = require('gulp'),
    util = require('gulp-util'),
    rename = require('gulp-rename');

module.exports = function (maps) {

    var stream = new Stream.Transform({objectMode: true});

    Q.all(maps.map(function (map) {
        var deferred = Q.defer(),
            src = path.normalize(map.src),
            dest = path.normalize(map.dest),
            last = dest[dest.length - 1],
            dir = dest;
        var gulpStream = gulp.src(src);
        if (last !== path.sep) {
            var splits = dest.split(path.sep),
                filename = splits[splits.length - 1];
            dir = dest.replace(filename, '');
            gulpStream = gulpStream.pipe(rename(filename));
        }
        gulpStream.pipe(gulp.dest(dir))
            .on('end', function () {
                util.log('Copy file', util.colors.cyan(src + ' -> ' + dest));
                deferred.resolve();
            }).on('error', function (err) {
                util.log(util.colors.red(err));
            });

        return deferred.promise;

    })).then(function () {
        stream.end();
    });

    return stream;
};
